---
- hosts: all
  gather_facts: yes
  post_tasks:
    - name: Get IP address corresponding to the interface with the specified broadcast address
      changed_when: no
      shell: "/usr/sbin/ip addr | grep {{broadcast_address}} | awk -F'[ /]+' '{print $3}'"
      register: ip_addr_broadcast
    - name: Configure Kubelet
      become: yes
      template:
        backup: no
        dest: /etc/systemd/system/kubelet.service.d/90-node-ip.conf
        group: root
        mode: 0755
        owner: root
        src: templates/90-node-ip.conf.j2
      register: configure_kubelet
    - name: Force systemd to reread configs
      become: yes
      systemd:
        daemon_reload: yes
      when: configure_kubelet.changed
    # - name: Initialize Kubernetes cluster
    #   become: yes
    #   shell: "/vagrant/scripts/linux/bootstrap-kubernetes-{{kubernetes_classifier}}.sh {{kubernetes_master_1_ip}} {{kubeadm_token}}"
    - name: Download gluster-kubernetes
      become: yes
      unarchive:
        dest: /opt
        remote_src: yes
        src: https://github.com/gluster/gluster-kubernetes/archive/master.zip
      when: inventory_hostname == kubernetes_master_1_ip
  roles:
    - role: ferrarimarco.kubernetes
      become: yes
      ferrarimarco_kubernetes_filesystem: glusterfs
    - role: andrewrothstein.kubernetes-helm
      become: yes
